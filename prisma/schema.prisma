// Prisma Schema for Claude Relay Service
// PostgreSQL + Redis 混合架构

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// 套餐管理系统
// ========================================

/// 套餐表 - 管理不同价格档位的订阅套餐
model Plan {
  id              String   @id @db.VarChar(50)
  name            String   @db.VarChar(100)
  description     String?  @db.Text
  type            String   @db.VarChar(20) // subscription | one-time

  // 价格信息
  price           Decimal  @db.Decimal(10, 2)
  originalPrice   Decimal? @map("original_price") @db.Decimal(10, 2)
  currency        String   @default("CNY") @db.VarChar(3)
  billingCycle    String?  @map("billing_cycle") @db.VarChar(20) // monthly | yearly | lifetime

  // 功能配置 (JSONB)
  features        Json     @default("{}")

  // 显示配置
  sortOrder       Int      @default(0) @map("sort_order")
  isPopular       Boolean  @default(false) @map("is_popular")
  isRecommended   Boolean  @default(false) @map("is_recommended")
  badgeText       String?  @map("badge_text") @db.VarChar(50)
  badgeColor      String?  @map("badge_color") @db.VarChar(20)

  // 试用和优惠
  trialDays       Int      @default(0) @map("trial_days")
  discount        Json?    // 优惠配置

  // 状态
  status          String   @default("active") @db.VarChar(20) // active | inactive | archived

  // 统计信息
  subscribersCount Int     @default(0) @map("subscribers_count")
  totalRevenue    Decimal  @default(0) @map("total_revenue") @db.Decimal(12, 2)

  // 时间戳
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // 关联
  subscriptions   Subscription[]
  orders          Order[]

  @@index([status])
  @@index([sortOrder], map: "idx_sort_order")
  @@index([billingCycle], map: "idx_billing_cycle")
  @@map("plans")
}

// ========================================
// 用户系统 (为未来迁移准备)
// ========================================

/// 用户表 - 存储邮箱登录用户账户信息
model User {
  id              String   @id @default(uuid()) @db.Uuid
  email           String   @unique @db.VarChar(255)
  passwordHash    String   @map("password_hash") @db.VarChar(255)
  emailVerified   Boolean  @default(false) @map("email_verified")
  status          String   @default("pending") @db.VarChar(20) // pending | active | suspended | deleted
  role            String   @default("user") @db.VarChar(20) // user | admin

  // 登录统计
  loginCount      Int      @default(0) @map("login_count")

  // 邀请信息
  referralCode    String?  @unique @map("referral_code") @db.VarChar(50)
  invitedById     String?  @map("invited_by") @db.Uuid
  invitedBy       User?    @relation("UserInvites", fields: [invitedById], references: [id])
  invitedUsers    User[]   @relation("UserInvites")

  // 时间戳
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  lastLoginAt     DateTime? @map("last_login_at")

  // 关联
  subscriptions   Subscription[]
  orders          Order[]
  apiKeys         ApiKey[]

  @@index([email])
  @@index([referralCode], map: "idx_referral_code")
  @@index([createdAt], map: "idx_user_created_at")
  @@index([status], map: "idx_user_status")
  @@map("users")
}

// ========================================
// API Key 管理系统
// ========================================

/// API Key 表 - 存储用户的 API 访问密钥
model ApiKey {
  id                    String   @id @default(uuid()) @db.Uuid
  name                  String   @db.VarChar(100)
  description           String?  @db.Text

  // 密钥信息（存储哈希值）
  keyHash               String   @unique @map("key_hash") @db.VarChar(64)

  // 状态
  isActive              Boolean  @default(true) @map("is_active")
  isDeleted             Boolean  @default(false) @map("is_deleted")
  deletedAt             DateTime? @map("deleted_at")
  deletedBy             String?  @map("deleted_by") @db.VarChar(100)
  deletedByType         String?  @map("deleted_by_type") @db.VarChar(20) // user | admin | system

  // 限制配置
  tokenLimit            BigInt   @default(0) @map("token_limit")
  concurrencyLimit      Int      @default(0) @map("concurrency_limit")
  rateLimitWindow       Int      @default(0) @map("rate_limit_window") // 分钟
  rateLimitRequests     Int      @default(0) @map("rate_limit_requests")
  rateLimitCost         Decimal  @default(0) @map("rate_limit_cost") @db.Decimal(10, 4)

  // 费用限制
  dailyCostLimit        Decimal  @default(0) @map("daily_cost_limit") @db.Decimal(10, 2)
  totalCostLimit        Decimal  @default(0) @map("total_cost_limit") @db.Decimal(10, 2)
  weeklyOpusCostLimit   Decimal  @default(0) @map("weekly_opus_cost_limit") @db.Decimal(10, 2)

  // 权限配置
  permissions           String   @default("all") @db.VarChar(50) // all | claude | gemini | openai | droid

  // 账户绑定
  claudeAccountId       String?  @map("claude_account_id") @db.VarChar(100)
  claudeConsoleAccountId String? @map("claude_console_account_id") @db.VarChar(100)
  geminiAccountId       String?  @map("gemini_account_id") @db.VarChar(100)
  openaiAccountId       String?  @map("openai_account_id") @db.VarChar(100)
  azureOpenaiAccountId  String?  @map("azure_openai_account_id") @db.VarChar(100)
  bedrockAccountId      String?  @map("bedrock_account_id") @db.VarChar(100)
  droidAccountId        String?  @map("droid_account_id") @db.VarChar(100)

  // 模型限制
  enableModelRestriction Boolean @default(false) @map("enable_model_restriction")
  restrictedModels      Json     @default("[]") @map("restricted_models")

  // 客户端限制
  enableClientRestriction Boolean @default(false) @map("enable_client_restriction")
  allowedClients        Json     @default("[]") @map("allowed_clients")

  // 标签
  tags                  Json     @default("[]")

  // 过期设置
  expirationMode        String   @default("fixed") @map("expiration_mode") @db.VarChar(20) // fixed | activation
  expiresAt             DateTime? @map("expires_at")
  activationDays        Int      @default(0) @map("activation_days")
  activationUnit        String   @default("days") @map("activation_unit") @db.VarChar(10) // hours | days
  isActivated           Boolean  @default(true) @map("is_activated")
  activatedAt           DateTime? @map("activated_at")

  // 图标
  icon                  String?  @db.Text

  // 创建者信息
  createdBy             String   @default("admin") @map("created_by") @db.VarChar(50)

  // 用户关联（可选，用户创建的 Key）
  userId                String?  @map("user_id") @db.Uuid
  user                  User?    @relation(fields: [userId], references: [id])
  userUsername          String?  @map("user_username") @db.VarChar(100)

  // 时间戳
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  lastUsedAt            DateTime? @map("last_used_at")

  @@index([keyHash], map: "idx_api_key_hash")
  @@index([userId], map: "idx_api_key_user_id")
  @@index([isActive], map: "idx_api_key_is_active")
  @@index([isDeleted], map: "idx_api_key_is_deleted")
  @@index([createdAt], map: "idx_api_key_created_at")
  @@index([permissions], map: "idx_api_key_permissions")
  @@map("api_keys")
}

// ========================================
// 订阅系统
// ========================================

/// 订阅表 - 用户的套餐订阅记录
model Subscription {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  planId          String   @map("plan_id") @db.VarChar(50)

  // 订单关联
  orderId         String?  @map("order_id") @db.VarChar(50)

  // 套餐快照 (防止套餐变更影响已有订阅)
  planSnapshot    Json     @map("plan_snapshot")

  // 状态
  status          String   @default("active") @db.VarChar(20) // active | expired | cancelled | suspended

  // 时间信息
  startDate       DateTime @map("start_date") @db.Date
  expireDate      DateTime @map("expire_date") @db.Date
  nextBillingDate DateTime? @map("next_billing_date") @db.Date
  cancelledAt     DateTime? @map("cancelled_at")
  suspendedAt     DateTime? @map("suspended_at")

  // 自动续费
  autoRenew       Boolean  @default(true) @map("auto_renew")
  autoRenewFailedCount Int @default(0) @map("auto_renew_failed_count")
  lastRenewAttemptAt DateTime? @map("last_renew_attempt_at")

  // 升级信息
  upgradedFromId  String?  @map("upgraded_from") @db.Uuid
  upgradedFrom    Subscription? @relation("SubscriptionUpgrade", fields: [upgradedFromId], references: [id])
  upgradedTo      Subscription[] @relation("SubscriptionUpgrade")

  // 时间戳
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // 关联
  user            User     @relation(fields: [userId], references: [id])
  plan            Plan     @relation(fields: [planId], references: [id])
  order           Order?   @relation(fields: [orderId], references: [id])
  changes         SubscriptionChange[]
  renewals        SubscriptionRenewal[]

  @@index([userId], map: "idx_subscription_user_id")
  @@index([status], map: "idx_subscription_status")
  @@index([expireDate], map: "idx_expire_date")
  @@index([nextBillingDate], map: "idx_next_billing_date")
  @@index([autoRenew], map: "idx_auto_renew")
  @@map("subscriptions")
}

// ========================================
// 订阅变更记录
// ========================================

/// 订阅变更记录表 - 记录订阅的所有变更历史
model SubscriptionChange {
  id              BigInt   @id @default(autoincrement())
  subscriptionId  String   @map("subscription_id") @db.Uuid
  userId          String   @map("user_id") @db.Uuid

  // 变更类型: created | renewed | upgraded | downgraded | cancelled | suspended | resumed | expired | auto_renew_enabled | auto_renew_disabled | scheduled_upgrade
  changeType      String   @map("change_type") @db.VarChar(30)

  // 变更前后对比
  oldPlanId       String?  @map("old_plan_id") @db.VarChar(50)
  newPlanId       String?  @map("new_plan_id") @db.VarChar(50)
  oldStatus       String?  @map("old_status") @db.VarChar(20)
  newStatus       String?  @map("new_status") @db.VarChar(20)
  oldExpireDate   DateTime? @map("old_expire_date") @db.Date
  newExpireDate   DateTime? @map("new_expire_date") @db.Date

  // 关联信息
  relatedOrderId  String?  @map("related_order_id") @db.VarChar(50)

  // 变更原因
  reason          String?  @db.Text

  // 操作人
  operatedBy      String?  @map("operated_by") @db.Uuid

  // 时间戳
  createdAt       DateTime @default(now()) @map("created_at")

  // 关联
  subscription    Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId], map: "idx_change_subscription_id")
  @@index([userId], map: "idx_change_user_id")
  @@index([changeType], map: "idx_change_type")
  @@index([createdAt], map: "idx_change_created_at")
  @@map("subscription_changes")
}

// ========================================
// 订阅续费记录
// ========================================

/// 订阅续费记录表 - 记录所有续费尝试
model SubscriptionRenewal {
  id              BigInt   @id @default(autoincrement())
  subscriptionId  String   @map("subscription_id") @db.Uuid
  orderId         String?  @map("order_id") @db.VarChar(50)

  // 续费信息
  renewalType     String   @map("renewal_type") @db.VarChar(20) // auto | manual
  renewalPrice    Decimal  @map("renewal_price") @db.Decimal(10, 2)

  // 状态: pending | success | failed
  status          String   @db.VarChar(20)

  // 失败信息
  failureReason   String?  @map("failure_reason") @db.Text
  retryCount      Int      @default(0) @map("retry_count")
  nextRetryAt     DateTime? @map("next_retry_at")

  // 时间信息
  attemptedAt     DateTime @default(now()) @map("attempted_at")
  succeededAt     DateTime? @map("succeeded_at")

  // 关联
  subscription    Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId], map: "idx_renewal_subscription_id")
  @@index([orderId], map: "idx_renewal_order_id")
  @@index([status], map: "idx_renewal_status")
  @@index([nextRetryAt], map: "idx_renewal_next_retry_at")
  @@map("subscription_renewals")
}

// ========================================
// 订单系统
// ========================================

/// 订单表 - 用户购买套餐的订单记录
model Order {
  id              String   @id @db.VarChar(50) // 订单号：ORD + 年月日 + 9位随机数

  // 关联信息
  userId          String   @map("user_id") @db.Uuid
  planId          String   @map("plan_id") @db.VarChar(50)

  // 套餐快照（记录购买时的套餐信息，防止套餐变更影响订单）
  planSnapshot    Json     @map("plan_snapshot")

  // 金额信息（单位：元，保留2位小数）
  originalPrice   Decimal  @map("original_price") @db.Decimal(10, 2)
  discountAmount  Decimal  @default(0) @map("discount_amount") @db.Decimal(10, 2)
  finalPrice      Decimal  @map("final_price") @db.Decimal(10, 2)
  currency        String   @default("CNY") @db.VarChar(3)

  // 优惠信息
  couponCode      String?  @map("coupon_code") @db.VarChar(50)
  couponDiscount  Decimal  @default(0) @map("coupon_discount") @db.Decimal(10, 2)
  inviteDiscount  Decimal  @default(0) @map("invite_discount") @db.Decimal(10, 2)

  // 订单状态
  status          String   @default("pending") @db.VarChar(20) // pending | paid | cancelled | expired | refunded
  paymentMethod   String?  @map("payment_method") @db.VarChar(20) // alipay | wechat | stripe
  paymentStatus   String   @default("pending") @map("payment_status") @db.VarChar(20) // pending | success | failed | refunded

  // 支付信息
  paymentInfo     Json?    @map("payment_info") // 支付相关信息（二维码、链接等）
  transactionId   String?  @map("transaction_id") @db.VarChar(100) // 第三方支付交易号

  // IP和设备信息
  userIp          String?  @map("user_ip") @db.VarChar(50)
  userAgent       String?  @map("user_agent") @db.Text

  // 备注
  note            String?  @db.Text
  cancelReason    String?  @map("cancel_reason") @db.Text
  refundReason    String?  @map("refund_reason") @db.Text

  // 时间信息
  createdAt       DateTime @default(now()) @map("created_at")
  paidAt          DateTime? @map("paid_at")
  cancelledAt     DateTime? @map("cancelled_at")
  refundedAt      DateTime? @map("refunded_at")
  expireAt        DateTime? @map("expire_at") // 订单过期时间（创建后15分钟）

  // 关联
  user            User     @relation(fields: [userId], references: [id])
  plan            Plan     @relation(fields: [planId], references: [id])
  paymentCallbacks PaymentCallback[]
  refunds         Refund[]
  subscriptions   Subscription[]

  @@index([userId], map: "idx_order_user_id")
  @@index([planId], map: "idx_order_plan_id")
  @@index([status], map: "idx_order_status")
  @@index([paymentStatus], map: "idx_order_payment_status")
  @@index([createdAt], map: "idx_order_created_at")
  @@index([expireAt], map: "idx_order_expire_at")
  @@index([transactionId], map: "idx_order_transaction_id")
  @@map("orders")
}

// ========================================
// 支付回调日志
// ========================================

/// 支付回调日志表 - 记录所有支付平台的回调
model PaymentCallback {
  id                BigInt   @id @default(autoincrement())
  orderId           String   @map("order_id") @db.VarChar(50)

  // 回调信息
  paymentMethod     String   @map("payment_method") @db.VarChar(20) // alipay | wechat | stripe
  callbackData      Json     @map("callback_data") // 完整的回调数据

  // 验证信息
  signatureValid    Boolean? @map("signature_valid")
  verificationResult String? @map("verification_result") @db.Text

  // 处理信息
  processed         Boolean  @default(false)
  processResult     String?  @map("process_result") @db.Text
  errorMessage      String?  @map("error_message") @db.Text

  // 来源信息
  sourceIp          String?  @map("source_ip") @db.VarChar(50)

  // 时间戳
  receivedAt        DateTime @default(now()) @map("received_at")
  processedAt       DateTime? @map("processed_at")

  // 关联
  order             Order    @relation(fields: [orderId], references: [id])

  @@index([orderId], map: "idx_callback_order_id")
  @@index([paymentMethod], map: "idx_callback_payment_method")
  @@index([processed], map: "idx_callback_processed")
  @@index([receivedAt], map: "idx_callback_received_at")
  @@map("payment_callbacks")
}

// ========================================
// 退款系统
// ========================================

/// 退款记录表 - 订单退款申请和处理记录
model Refund {
  id                  String   @id @db.VarChar(50) // 退款单号：REF + 年月日 + 9位随机数
  orderId             String   @map("order_id") @db.VarChar(50)

  // 退款信息
  refundAmount        Decimal  @map("refund_amount") @db.Decimal(10, 2)
  refundReason        String?  @map("refund_reason") @db.Text
  refundType          String   @map("refund_type") @db.VarChar(20) // full | partial

  // 状态
  status              String   @default("pending") @db.VarChar(20) // pending | processing | success | failed | rejected

  // 第三方信息
  refundTransactionId String?  @map("refund_transaction_id") @db.VarChar(100)

  // 操作信息
  createdBy           String?  @map("created_by") @db.Uuid // 申请人（用户ID）
  approvedBy          String?  @map("approved_by") @db.Uuid // 审批人（管理员ID）
  rejectedBy          String?  @map("rejected_by") @db.Uuid
  rejectedReason      String?  @map("rejected_reason") @db.Text

  // 时间信息
  createdAt           DateTime @default(now()) @map("created_at")
  approvedAt          DateTime? @map("approved_at")
  completedAt         DateTime? @map("completed_at")
  rejectedAt          DateTime? @map("rejected_at")

  // 关联
  order               Order    @relation(fields: [orderId], references: [id])

  @@index([orderId], map: "idx_refund_order_id")
  @@index([status], map: "idx_refund_status")
  @@index([createdAt], map: "idx_refund_created_at")
  @@map("refunds")
}
