openapi: 3.0.3
info:
  title: Claude Relay Service - Email Auth API
  description: |
    邮箱认证系统 API 文档

    ## 认证方式

    除了注册、登录等公开接口外，其他接口需要在请求头中携带 JWT Token：
    ```
    Authorization: Bearer <accessToken>
    ```

    ## Token 刷新机制

    - Access Token 有效期：1 小时（可配置）
    - Refresh Token 有效期：7 天（可配置）
    - 当 Access Token 过期时，使用 Refresh Token 获取新的 Token 对

  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com

servers:
  - url: http://localhost:3000
    description: 开发环境
  - url: https://api.example.com
    description: 生产环境

tags:
  - name: Auth
    description: 认证相关接口（注册、登录、验证等）
  - name: User
    description: 用户相关接口（个人信息、API Key 管理）

security:
  - BearerAuth: []

paths:
  # ==================== 认证接口 ====================
  /api/v1/auth/register:
    post:
      tags:
        - Auth
      summary: 用户注册
      description: 注册新用户，成功后发送验证邮件
      operationId: register
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
            example:
              email: user@example.com
              password: your-password-123
      responses:
        '201':
          description: 注册成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: VALIDATION_ERROR
                  message: 邮箱格式不正确
        '409':
          description: 邮箱已被注册
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: AUTH_EMAIL_EXISTS
                  message: 该邮箱已被注册

  /api/v1/auth/login:
    post:
      tags:
        - Auth
      summary: 用户登录
      description: 使用邮箱和密码登录，返回 Access Token 和 Refresh Token
      operationId: login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            example:
              email: user@example.com
              password: your-password-123
      responses:
        '200':
          description: 登录成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: 认证失败
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_credentials:
                  summary: 邮箱或密码错误
                  value:
                    success: false
                    error:
                      code: AUTH_INVALID_CREDENTIALS
                      message: 邮箱或密码错误
                email_not_verified:
                  summary: 邮箱未验证
                  value:
                    success: false
                    error:
                      code: AUTH_EMAIL_NOT_VERIFIED
                      message: 请先验证邮箱

  /api/v1/auth/logout:
    post:
      tags:
        - Auth
      summary: 用户登出
      description: 登出当前用户，使当前 Token 失效
      operationId: logout
      responses:
        '200':
          description: 登出成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                success: true
                message: 登出成功
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/auth/refresh:
    post:
      tags:
        - Auth
      summary: 刷新 Token
      description: 使用 Refresh Token 获取新的 Access Token 和 Refresh Token
      operationId: refreshToken
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
            example:
              refreshToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: Token 刷新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefreshTokenResponse'
        '401':
          description: Refresh Token 无效或已过期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: AUTH_TOKEN_INVALID
                  message: Token 无效或已过期

  /api/v1/auth/verify-email:
    get:
      tags:
        - Auth
      summary: 邮箱验证（API）
      description: 验证用户邮箱，返回 JSON 响应
      operationId: verifyEmailApi
      security: []
      parameters:
        - name: token
          in: query
          required: true
          description: 邮箱验证 Token
          schema:
            type: string
      responses:
        '200':
          description: 验证成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                success: true
                message: 邮箱验证成功
        '400':
          description: 验证失败
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: AUTH_TOKEN_INVALID
                  message: 验证链接无效或已过期

  /verify-email:
    get:
      tags:
        - Auth
      summary: 邮箱验证（网页）
      description: 验证用户邮箱，返回 HTML 页面
      operationId: verifyEmailPage
      security: []
      parameters:
        - name: token
          in: query
          required: true
          description: 邮箱验证 Token
          schema:
            type: string
      responses:
        '200':
          description: 验证结果页面
          content:
            text/html:
              schema:
                type: string
                description: HTML 页面，显示验证成功或失败信息

  /api/v1/auth/resend-verification:
    post:
      tags:
        - Auth
      summary: 重发验证邮件
      description: 重新发送邮箱验证邮件
      operationId: resendVerification
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  description: 用户邮箱
            example:
              email: user@example.com
      responses:
        '200':
          description: 验证邮件已发送
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                success: true
                message: 验证邮件已发送
        '404':
          description: 用户不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: USER_NOT_FOUND
                  message: 用户不存在

  /api/v1/auth/forgot-password:
    post:
      tags:
        - Auth
      summary: 忘记密码
      description: 发送密码重置邮件
      operationId: forgotPassword
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  description: 用户邮箱
            example:
              email: user@example.com
      responses:
        '200':
          description: 重置密码邮件已发送
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                success: true
                message: 重置密码邮件已发送

  /api/v1/auth/reset-password:
    post:
      tags:
        - Auth
      summary: 重置密码
      description: 使用重置 Token 设置新密码
      operationId: resetPassword
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
            example:
              token: reset-token-here
              newPassword: new-password-123
      responses:
        '200':
          description: 密码重置成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                success: true
                message: 密码重置成功
        '400':
          description: Token 无效或已过期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: AUTH_TOKEN_INVALID
                  message: 重置链接无效或已过期

  # ==================== 用户接口 ====================
  /api/v1/user/profile:
    get:
      tags:
        - User
      summary: 获取用户信息
      description: 获取当前登录用户的个人信息
      operationId: getProfile
      responses:
        '200':
          description: 成功获取用户信息
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    put:
      tags:
        - User
      summary: 更新用户信息
      description: 更新当前登录用户的个人信息
      operationId: updateProfile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProfileRequest'
            example:
              displayName: 新的显示名称
      responses:
        '200':
          description: 用户信息更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/user/password:
    put:
      tags:
        - User
      summary: 修改密码
      description: 修改当前登录用户的密码
      operationId: changePassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangePasswordRequest'
            example:
              currentPassword: old-password
              newPassword: new-password-123
      responses:
        '200':
          description: 密码修改成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                success: true
                message: 密码修改成功
        '400':
          description: 当前密码错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: AUTH_INVALID_CREDENTIALS
                  message: 当前密码错误
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/user/api-keys:
    get:
      tags:
        - User
      summary: 获取用户 API Keys
      description: 获取当前用户创建的所有 API Keys
      operationId: getApiKeys
      responses:
        '200':
          description: 成功获取 API Keys 列表
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeysListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - User
      summary: 创建 API Key
      description: |
        为当前用户创建新的 API Key

        **注意**：完整的 API Key 只在创建时返回一次，请妥善保存
      operationId: createApiKey
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateApiKeyRequest'
            example:
              name: My API Key
      responses:
        '201':
          description: API Key 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateApiKeyResponse'
        '400':
          description: API Key 数量已达上限
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: API_KEY_LIMIT_REACHED
                  message: API Key 数量已达上限
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/user/api-keys/{keyId}:
    delete:
      tags:
        - User
      summary: 删除 API Key
      description: 删除指定的 API Key（需要配置 ALLOW_EMAIL_USER_DELETE_API_KEYS=true）
      operationId: deleteApiKey
      parameters:
        - name: keyId
          in: path
          required: true
          description: API Key ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: API Key 删除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                success: true
                message: API Key 删除成功
        '403':
          description: 无权删除 API Key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: FORBIDDEN
                  message: 不允许删除 API Key
        '404':
          description: API Key 不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: NOT_FOUND
                  message: API Key 不存在
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT Access Token

  responses:
    Unauthorized:
      description: 未授权访问
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: AUTH_UNAUTHORIZED
              message: 未授权访问

  schemas:
    # ==================== 请求模型 ====================
    RegisterRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: 用户邮箱
          example: user@example.com
        password:
          type: string
          format: password
          minLength: 6
          description: 用户密码（至少 6 位）
          example: your-password-123

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: 用户邮箱
          example: user@example.com
        password:
          type: string
          format: password
          description: 用户密码
          example: your-password-123

    RefreshTokenRequest:
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string
          description: Refresh Token
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

    ResetPasswordRequest:
      type: object
      required:
        - token
        - newPassword
      properties:
        token:
          type: string
          description: 密码重置 Token
        newPassword:
          type: string
          format: password
          minLength: 6
          description: 新密码（至少 6 位）

    UpdateProfileRequest:
      type: object
      properties:
        displayName:
          type: string
          maxLength: 100
          description: 显示名称
          example: 新的显示名称

    ChangePasswordRequest:
      type: object
      required:
        - currentPassword
        - newPassword
      properties:
        currentPassword:
          type: string
          format: password
          description: 当前密码
        newPassword:
          type: string
          format: password
          minLength: 6
          description: 新密码（至少 6 位）

    CreateApiKeyRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          maxLength: 100
          description: API Key 名称
          example: My API Key

    # ==================== 响应模型 ====================
    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: 操作成功

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              description: 错误码
              example: AUTH_INVALID_CREDENTIALS
            message:
              type: string
              description: 错误信息
              example: 邮箱或密码错误

    RegisterResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: 注册成功，请查收验证邮件
        data:
          type: object
          properties:
            userId:
              type: string
              format: uuid
              description: 用户 ID
            email:
              type: string
              format: email
              description: 用户邮箱
            emailVerified:
              type: boolean
              description: 邮箱是否已验证
              example: false

    LoginResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: 登录成功
        data:
          type: object
          properties:
            accessToken:
              type: string
              description: JWT Access Token
            refreshToken:
              type: string
              description: JWT Refresh Token
            expiresIn:
              type: integer
              description: Access Token 有效期（秒）
              example: 3600
            user:
              $ref: '#/components/schemas/UserInfo'

    RefreshTokenResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            accessToken:
              type: string
              description: 新的 JWT Access Token
            refreshToken:
              type: string
              description: 新的 JWT Refresh Token
            expiresIn:
              type: integer
              description: Access Token 有效期（秒）
              example: 3600

    ProfileResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/UserInfo'

    UserInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: 用户 ID
        email:
          type: string
          format: email
          description: 用户邮箱
        displayName:
          type: string
          description: 显示名称
        emailVerified:
          type: boolean
          description: 邮箱是否已验证
        createdAt:
          type: string
          format: date-time
          description: 创建时间

    ApiKeyInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: API Key ID
        name:
          type: string
          description: API Key 名称
        keyPreview:
          type: string
          description: API Key 预览（部分隐藏）
          example: cr_****abcd
        createdAt:
          type: string
          format: date-time
          description: 创建时间
        lastUsedAt:
          type: string
          format: date-time
          nullable: true
          description: 最后使用时间

    ApiKeysListResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: array
          items:
            $ref: '#/components/schemas/ApiKeyInfo'

    CreateApiKeyResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: API Key 创建成功
        data:
          type: object
          properties:
            id:
              type: string
              format: uuid
              description: API Key ID
            name:
              type: string
              description: API Key 名称
            key:
              type: string
              description: 完整的 API Key（仅此一次显示）
              example: cr_xxxxxxxxxxxxxxxx
