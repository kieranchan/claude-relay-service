# ä¼˜æƒ åˆ¸ç³»ç»Ÿè¯¦ç»†è®¾è®¡æ–‡æ¡£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ä¼˜æƒ åˆ¸ç³»ç»Ÿç”¨äºè¥é”€æ¨å¹¿ï¼Œé€šè¿‡å‘æ”¾ä¼˜æƒ åˆ¸å¸å¼•ç”¨æˆ·è´­ä¹°ï¼Œæé«˜è½¬åŒ–ç‡å’Œç”¨æˆ·ç•™å­˜ã€‚

### æ ¸å¿ƒåŠŸèƒ½

- âœ… ä¼˜æƒ åˆ¸åˆ›å»ºå’Œç®¡ç†
- âœ… å¤šç§ä¼˜æƒ åˆ¸ç±»å‹ï¼ˆæ»¡å‡ã€æŠ˜æ‰£ã€å›ºå®šé‡‘é¢ï¼‰
- âœ… ä½¿ç”¨æ¡ä»¶é™åˆ¶
- âœ… æ‰¹é‡å‘æ”¾å’Œé¢†å–
- âœ… ä¼˜æƒ åˆ¸ç ç”Ÿæˆ
- âœ… ä½¿ç”¨éªŒè¯å’Œè®°å½•
- âœ… ç»Ÿè®¡å’Œåˆ†æ

### ä¸šåŠ¡åœºæ™¯

```
ç®¡ç†å‘˜åœºæ™¯ï¼š
1. åˆ›å»ºä¼˜æƒ åˆ¸æ´»åŠ¨
2. è®¾ç½®ä½¿ç”¨æ¡ä»¶å’Œé™åˆ¶
3. æ‰¹é‡ç”Ÿæˆä¼˜æƒ åˆ¸ç 
4. æŸ¥çœ‹ä½¿ç”¨ç»Ÿè®¡

ç”¨æˆ·åœºæ™¯ï¼š
1. é¢†å–ä¼˜æƒ åˆ¸
2. æŸ¥çœ‹å¯ç”¨ä¼˜æƒ åˆ¸
3. ä¸‹å•æ—¶ä½¿ç”¨ä¼˜æƒ åˆ¸
4. æŸ¥çœ‹ä½¿ç”¨å†å²
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. ä¼˜æƒ åˆ¸æ¨¡æ¿è¡¨ï¼ˆcouponsï¼‰

```sql
CREATE TABLE coupons (
    id VARCHAR(50) PRIMARY KEY,              -- ä¼˜æƒ åˆ¸ID
    
    -- åŸºæœ¬ä¿¡æ¯
    name VARCHAR(100) NOT NULL,              -- ä¼˜æƒ åˆ¸åç§°
    description TEXT,                        -- æè¿°
    code VARCHAR(50) UNIQUE,                 -- ä¼˜æƒ åˆ¸ç ï¼ˆå¯é€‰ï¼Œä¸ºç©ºè¡¨ç¤ºéœ€è¦é¢†å–ï¼‰
    
    -- ä¼˜æƒ ç±»å‹
    type VARCHAR(20) NOT NULL,               -- percentage(ç™¾åˆ†æ¯”æŠ˜æ‰£) | fixed_amount(å›ºå®šé‡‘é¢) | full_reduction(æ»¡å‡)
    value DECIMAL(10, 2) NOT NULL,           -- ä¼˜æƒ å€¼
    
    -- æ»¡å‡æ¡ä»¶
    min_purchase_amount DECIMAL(10, 2),      -- æœ€ä½æ¶ˆè´¹é‡‘é¢
    max_discount_amount DECIMAL(10, 2),      -- æœ€å¤§ä¼˜æƒ é‡‘é¢ï¼ˆç”¨äºç™¾åˆ†æ¯”æŠ˜æ‰£ï¼‰
    
    -- é€‚ç”¨èŒƒå›´
    applicable_plans JSONB,                  -- é€‚ç”¨çš„å¥—é¤åˆ—è¡¨ï¼Œnullè¡¨ç¤ºå…¨éƒ¨å¥—é¤
    exclude_plans JSONB,                     -- æ’é™¤çš„å¥—é¤åˆ—è¡¨
    
    -- ä½¿ç”¨é™åˆ¶
    total_quantity INTEGER,                  -- æ€»å‘è¡Œé‡ï¼Œnullè¡¨ç¤ºæ— é™åˆ¶
    used_quantity INTEGER DEFAULT 0,         -- å·²ä½¿ç”¨æ•°é‡
    per_user_limit INTEGER DEFAULT 1,        -- æ¯ä¸ªç”¨æˆ·å¯ä½¿ç”¨æ¬¡æ•°
    
    -- æ—¶é—´é™åˆ¶
    start_time TIMESTAMP NOT NULL,           -- å¼€å§‹æ—¶é—´
    end_time TIMESTAMP NOT NULL,             -- ç»“æŸæ—¶é—´
    
    -- çŠ¶æ€
    status VARCHAR(20) DEFAULT 'active',     -- active | inactive | expired
    
    -- æ˜¯å¦å¯å åŠ ä½¿ç”¨
    stackable BOOLEAN DEFAULT FALSE,
    
    -- å‘æ”¾æ–¹å¼
    distribution_type VARCHAR(20) NOT NULL,  -- public(å…¬å¼€é¢†å–) | code(ä¼˜æƒ ç ) | targeted(å®šå‘å‘æ”¾)
    
    -- ç»Ÿè®¡ä¿¡æ¯
    received_count INTEGER DEFAULT 0,        -- å·²é¢†å–æ•°é‡
    used_count INTEGER DEFAULT 0,            -- å·²ä½¿ç”¨æ•°é‡
    
    -- åˆ›å»ºä¿¡æ¯
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- ç´¢å¼•
    INDEX idx_code (code),
    INDEX idx_status (status),
    INDEX idx_type (type),
    INDEX idx_start_time (start_time),
    INDEX idx_end_time (end_time)
);

-- æ›´æ–°è§¦å‘å™¨
CREATE TRIGGER update_coupons_updated_at
    BEFORE UPDATE ON coupons
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

### 2. ç”¨æˆ·ä¼˜æƒ åˆ¸è¡¨ï¼ˆuser_couponsï¼‰

```sql
CREATE TABLE user_coupons (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    coupon_id VARCHAR(50) NOT NULL REFERENCES coupons(id),
    
    -- ä½¿ç”¨çŠ¶æ€
    status VARCHAR(20) DEFAULT 'available',  -- available | used | expired
    
    -- ä½¿ç”¨ä¿¡æ¯
    order_id VARCHAR(50) REFERENCES orders(id),
    used_at TIMESTAMP,
    
    -- é¢†å–ä¿¡æ¯
    received_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- è¿‡æœŸæ—¶é—´ï¼ˆå¯èƒ½ä¸couponçš„end_timeä¸åŒï¼Œç”¨äºä¸ªæ€§åŒ–å‘æ”¾ï¼‰
    expire_at TIMESTAMP,
    
    -- ç´¢å¼•
    INDEX idx_user_id (user_id),
    INDEX idx_coupon_id (coupon_id),
    INDEX idx_status (status),
    INDEX idx_order_id (order_id),
    INDEX idx_expire_at (expire_at),
    
    -- çº¦æŸï¼šåŒä¸€ç”¨æˆ·ä¸èƒ½é‡å¤é¢†å–åŒä¸€ä¼˜æƒ åˆ¸ï¼ˆæ ¹æ®per_user_limitï¼‰
    UNIQUE INDEX idx_user_coupon (user_id, coupon_id)
);
```

### 3. ä¼˜æƒ åˆ¸ä½¿ç”¨è®°å½•è¡¨ï¼ˆcoupon_usagesï¼‰

```sql
CREATE TABLE coupon_usages (
    id BIGSERIAL PRIMARY KEY,
    user_coupon_id BIGINT NOT NULL REFERENCES user_coupons(id),
    user_id UUID NOT NULL REFERENCES users(id),
    coupon_id VARCHAR(50) NOT NULL REFERENCES coupons(id),
    order_id VARCHAR(50) NOT NULL REFERENCES orders(id),
    
    -- ä½¿ç”¨è¯¦æƒ…
    original_price DECIMAL(10, 2) NOT NULL,  -- åŸä»·
    discount_amount DECIMAL(10, 2) NOT NULL, -- ä¼˜æƒ é‡‘é¢
    final_price DECIMAL(10, 2) NOT NULL,     -- æœ€ç»ˆä»·æ ¼
    
    -- æ—¶é—´
    used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- ç´¢å¼•
    INDEX idx_user_id (user_id),
    INDEX idx_coupon_id (coupon_id),
    INDEX idx_order_id (order_id),
    INDEX idx_used_at (used_at)
);
```

---

## ğŸ“¡ APIæ¥å£è®¾è®¡

### æ¥å£åˆ—è¡¨

| æ–¹æ³• | ç«¯ç‚¹ | æè¿° | è®¤è¯ |
|------|------|------|------|
| GET | `/api/v1/coupons/available` | è·å–å¯é¢†å–ä¼˜æƒ åˆ¸ | ç”¨æˆ· |
| GET | `/api/v1/coupons/my` | è·å–æˆ‘çš„ä¼˜æƒ åˆ¸ | ç”¨æˆ· |
| POST | `/api/v1/coupons/receive/:id` | é¢†å–ä¼˜æƒ åˆ¸ | ç”¨æˆ· |
| POST | `/api/v1/coupons/exchange` | å…‘æ¢ä¼˜æƒ ç  | ç”¨æˆ· |
| POST | `/api/v1/coupons/validate` | éªŒè¯ä¼˜æƒ åˆ¸ | ç”¨æˆ· |
| POST | `/api/v1/admin/coupons` | åˆ›å»ºä¼˜æƒ åˆ¸ | ç®¡ç†å‘˜ |
| PUT | `/api/v1/admin/coupons/:id` | æ›´æ–°ä¼˜æƒ åˆ¸ | ç®¡ç†å‘˜ |
| DELETE | `/api/v1/admin/coupons/:id` | åˆ é™¤ä¼˜æƒ åˆ¸ | ç®¡ç†å‘˜ |
| GET | `/api/v1/admin/coupons/:id/stats` | è·å–ç»Ÿè®¡ä¿¡æ¯ | ç®¡ç†å‘˜ |
| POST | `/api/v1/admin/coupons/:id/distribute` | æ‰¹é‡å‘æ”¾ | ç®¡ç†å‘˜ |

---

### 1. è·å–å¯é¢†å–ä¼˜æƒ åˆ¸åˆ—è¡¨

**ç«¯ç‚¹ï¼š** `GET /api/v1/coupons/available`

**å“åº”ï¼š**
```json
{
  "success": true,
  "data": [
    {
      "id": "NEWUSER2024",
      "name": "æ–°ç”¨æˆ·ä¸“äº«",
      "description": "é¦–æ¬¡è´­ä¹°ç«‹å‡20å…ƒ",
      "type": "fixed_amount",
      "value": 20.00,
      "min_purchase_amount": 50.00,
      "start_time": "2024-01-01T00:00:00Z",
      "end_time": "2024-12-31T23:59:59Z",
      "can_receive": true,
      "received": false,
      "remaining_quantity": 850
    },
    {
      "id": "SPRING2024",
      "name": "æ˜¥å­£ä¿ƒé”€",
      "description": "å…¨åœº9æŠ˜ä¼˜æƒ ",
      "type": "percentage",
      "value": 10,
      "max_discount_amount": 50.00,
      "start_time": "2024-03-01T00:00:00Z",
      "end_time": "2024-03-31T23:59:59Z",
      "can_receive": false,
      "received": true,
      "remaining_quantity": null
    }
  ]
}
```

---

### 2. è·å–æˆ‘çš„ä¼˜æƒ åˆ¸

**ç«¯ç‚¹ï¼š** `GET /api/v1/coupons/my`

**æŸ¥è¯¢å‚æ•°ï¼š**
- `status`: available | used | expired

**å“åº”ï¼š**
```json
{
  "success": true,
  "data": [
    {
      "user_coupon_id": 12345,
      "coupon": {
        "id": "NEWUSER2024",
        "name": "æ–°ç”¨æˆ·ä¸“äº«",
        "description": "é¦–æ¬¡è´­ä¹°ç«‹å‡20å…ƒ",
        "type": "fixed_amount",
        "value": 20.00,
        "min_purchase_amount": 50.00
      },
      "status": "available",
      "received_at": "2024-01-26T10:00:00Z",
      "expire_at": "2024-12-31T23:59:59Z",
      "days_remaining": 339
    },
    {
      "user_coupon_id": 12346,
      "coupon": {
        "id": "WELCOME20",
        "name": "æ¬¢è¿ç¤¼åˆ¸",
        "type": "percentage",
        "value": 20
      },
      "status": "used",
      "received_at": "2024-01-15T10:00:00Z",
      "used_at": "2024-01-20T15:30:00Z",
      "order_id": "ORD20240120123456789"
    }
  ]
}
```

---

### 3. é¢†å–ä¼˜æƒ åˆ¸

**ç«¯ç‚¹ï¼š** `POST /api/v1/coupons/receive/:id`

**å“åº”ï¼ˆæˆåŠŸï¼‰ï¼š**
```json
{
  "success": true,
  "message": "ä¼˜æƒ åˆ¸é¢†å–æˆåŠŸ",
  "data": {
    "user_coupon_id": 12347,
    "coupon": {
      "id": "NEWUSER2024",
      "name": "æ–°ç”¨æˆ·ä¸“äº«",
      "value": 20.00,
      "type": "fixed_amount"
    },
    "expire_at": "2024-12-31T23:59:59Z"
  }
}
```

**å“åº”ï¼ˆå¤±è´¥ï¼‰ï¼š**
```json
{
  "success": false,
  "error": {
    "code": "COUPON_ALREADY_RECEIVED",
    "message": "æ‚¨å·²é¢†å–è¿‡è¯¥ä¼˜æƒ åˆ¸"
  }
}
```

```json
{
  "success": false,
  "error": {
    "code": "COUPON_LIMIT_REACHED",
    "message": "ä¼˜æƒ åˆ¸å·²è¢«é¢†å®Œ"
  }
}
```

---

### 4. å…‘æ¢ä¼˜æƒ ç 

**ç«¯ç‚¹ï¼š** `POST /api/v1/coupons/exchange`

**è¯·æ±‚ä½“ï¼š**
```json
{
  "code": "WELCOME2024"
}
```

**å“åº”ï¼š**
```json
{
  "success": true,
  "message": "ä¼˜æƒ ç å…‘æ¢æˆåŠŸ",
  "data": {
    "user_coupon_id": 12348,
    "coupon": {
      "id": "WELCOME2024",
      "name": "æ–°äººç¤¼åŒ…",
      "description": "é¦–å•ç«‹å‡30å…ƒ",
      "type": "fixed_amount",
      "value": 30.00
    },
    "expire_at": "2024-12-31T23:59:59Z"
  }
}
```

**é”™è¯¯å“åº”ï¼š**
```json
{
  "success": false,
  "error": {
    "code": "INVALID_COUPON_CODE",
    "message": "æ— æ•ˆçš„ä¼˜æƒ ç "
  }
}
```

---

### 5. éªŒè¯ä¼˜æƒ åˆ¸ï¼ˆä¸‹å•å‰ï¼‰

**ç«¯ç‚¹ï¼š** `POST /api/v1/coupons/validate`

**è¯·æ±‚ä½“ï¼š**
```json
{
  "coupon_code": "NEWUSER2024",
  "plan_id": "pro_monthly",
  "amount": 99.00
}
```

**å“åº”ï¼ˆæœ‰æ•ˆï¼‰ï¼š**
```json
{
  "success": true,
  "data": {
    "valid": true,
    "coupon": {
      "id": "NEWUSER2024",
      "name": "æ–°ç”¨æˆ·ä¸“äº«",
      "type": "fixed_amount",
      "value": 20.00
    },
    "discount_amount": 20.00,
    "final_amount": 79.00
  }
}
```

**å“åº”ï¼ˆæ— æ•ˆï¼‰ï¼š**
```json
{
  "success": true,
  "data": {
    "valid": false,
    "reason": "æœªè¾¾åˆ°æœ€ä½æ¶ˆè´¹é‡‘é¢",
    "min_purchase_amount": 50.00
  }
}
```

---

### 6. åˆ›å»ºä¼˜æƒ åˆ¸ï¼ˆç®¡ç†å‘˜ï¼‰

**ç«¯ç‚¹ï¼š** `POST /api/v1/admin/coupons`

**è¯·æ±‚ä½“ï¼š**
```json
{
  "id": "SUMMER2024",
  "name": "å¤å­£ä¿ƒé”€",
  "description": "å…¨åœº8æŠ˜ä¼˜æƒ ï¼Œæœ€é«˜ä¼˜æƒ 100å…ƒ",
  "type": "percentage",
  "value": 20,
  "max_discount_amount": 100.00,
  "min_purchase_amount": 100.00,
  "applicable_plans": ["pro_monthly", "pro_yearly", "ultimate_monthly"],
  "total_quantity": 1000,
  "per_user_limit": 1,
  "start_time": "2024-06-01T00:00:00Z",
  "end_time": "2024-08-31T23:59:59Z",
  "distribution_type": "public",
  "stackable": false
}
```

**å“åº”ï¼š**
```json
{
  "success": true,
  "message": "ä¼˜æƒ åˆ¸åˆ›å»ºæˆåŠŸ",
  "data": {
    "id": "SUMMER2024",
    "name": "å¤å­£ä¿ƒé”€",
    "status": "active",
    "created_at": "2024-01-26T12:00:00Z"
  }
}
```

---

### 7. æ‰¹é‡å‘æ”¾ä¼˜æƒ åˆ¸

**ç«¯ç‚¹ï¼š** `POST /api/v1/admin/coupons/:id/distribute`

**è¯·æ±‚ä½“ï¼š**
```json
{
  "target_type": "user_ids",
  "targets": ["user-uuid-1", "user-uuid-2", "user-uuid-3"],
  "expire_days": 7
}
```

æˆ–è€…ï¼š
```json
{
  "target_type": "user_filter",
  "filter": {
    "registered_after": "2024-01-01",
    "no_subscription": true
  },
  "expire_days": 7
}
```

**å“åº”ï¼š**
```json
{
  "success": true,
  "message": "ä¼˜æƒ åˆ¸å‘æ”¾æˆåŠŸ",
  "data": {
    "distributed_count": 3,
    "target_users": 3
  }
}
```

---

### 8. è·å–ä¼˜æƒ åˆ¸ç»Ÿè®¡

**ç«¯ç‚¹ï¼š** `GET /api/v1/admin/coupons/:id/stats`

**å“åº”ï¼š**
```json
{
  "success": true,
  "data": {
    "coupon_id": "NEWUSER2024",
    "name": "æ–°ç”¨æˆ·ä¸“äº«",
    "total_quantity": 1000,
    "received_count": 356,
    "used_count": 142,
    "usage_rate": 39.89,
    "total_discount": 2840.00,
    "total_revenue": 12458.00,
    "avg_discount_per_order": 20.00,
    "top_users": [
      {
        "user_id": "user-uuid",
        "email": "user@example.com",
        "used_count": 1,
        "discount_amount": 20.00
      }
    ],
    "daily_stats": [
      {
        "date": "2024-01-26",
        "received": 15,
        "used": 6
      }
    ]
  }
}
```

---

## ğŸ’» åç«¯å®ç°

### 1. ä¼˜æƒ åˆ¸æ¨¡å‹ï¼ˆCoupon.jsï¼‰

```javascript
// src/models/Coupon.js

const db = require('../config/database');

class Coupon {
  /**
   * åˆ›å»ºä¼˜æƒ åˆ¸
   */
  static async create(couponData) {
    const {
      id, name, description, code, type, value,
      minPurchaseAmount, maxDiscountAmount,
      applicablePlans, excludePlans,
      totalQuantity, perUserLimit,
      startTime, endTime, distributionType, stackable, createdBy
    } = couponData;
    
    const result = await db.query(
      `INSERT INTO coupons (
        id, name, description, code, type, value,
        min_purchase_amount, max_discount_amount,
        applicable_plans, exclude_plans,
        total_quantity, per_user_limit,
        start_time, end_time, distribution_type, stackable, created_by
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17)
      RETURNING *`,
      [
        id, name, description, code, type, value,
        minPurchaseAmount, maxDiscountAmount,
        applicablePlans ? JSON.stringify(applicablePlans) : null,
        excludePlans ? JSON.stringify(excludePlans) : null,
        totalQuantity, perUserLimit,
        startTime, endTime, distributionType, stackable, createdBy
      ]
    );
    
    return result.rows[0];
  }
  
  /**
   * æ ¹æ®IDè·å–ä¼˜æƒ åˆ¸
   */
  static async findById(couponId) {
    const result = await db.query(
      'SELECT * FROM coupons WHERE id = $1',
      [couponId]
    );
    
    return result.rows[0] || null;
  }
  
  /**
   * æ ¹æ®ä¼˜æƒ ç è·å–ä¼˜æƒ åˆ¸
   */
  static async findByCode(code) {
    const result = await db.query(
      'SELECT * FROM coupons WHERE code = $1',
      [code]
    );
    
    return result.rows[0] || null;
  }
  
  /**
   * è·å–æ‰€æœ‰å¯é¢†å–çš„ä¼˜æƒ åˆ¸
   */
  static async getAvailable() {
    const result = await db.query(
      `SELECT * FROM coupons 
       WHERE status = 'active' 
       AND distribution_type = 'public'
       AND start_time <= NOW() 
       AND end_time > NOW()
       ORDER BY created_at DESC`
    );
    
    return result.rows;
  }
  
  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²é¢†å–
   */
  static async hasUserReceived(userId, couponId) {
    const result = await db.query(
      `SELECT COUNT(*) FROM user_coupons 
       WHERE user_id = $1 AND coupon_id = $2`,
      [userId, couponId]
    );
    
    return parseInt(result.rows[0].count) > 0;
  }
  
  /**
   * æ£€æŸ¥ç”¨æˆ·é¢†å–æ¬¡æ•°
   */
  static async getUserReceiveCount(userId, couponId) {
    const result = await db.query(
      `SELECT COUNT(*) FROM user_coupons 
       WHERE user_id = $1 AND coupon_id = $2`,
      [userId, couponId]
    );
    
    return parseInt(result.rows[0].count);
  }
  
  /**
   * å¢åŠ å·²é¢†å–æ•°é‡
   */
  static async incrementReceivedCount(couponId) {
    await db.query(
      'UPDATE coupons SET received_count = received_count + 1 WHERE id = $1',
      [couponId]
    );
  }
  
  /**
   * å¢åŠ å·²ä½¿ç”¨æ•°é‡
   */
  static async incrementUsedCount(couponId) {
    await db.query(
      'UPDATE coupons SET used_count = used_count + 1 WHERE id = $1',
      [couponId]
    );
  }
  
  /**
   * æ›´æ–°ä¼˜æƒ åˆ¸
   */
  static async update(couponId, updates) {
    const fields = [];
    const params = [];
    let paramIndex = 1;
    
    for (const [key, value] of Object.entries(updates)) {
      fields.push(`${key} = $${paramIndex}`);
      params.push(value);
      paramIndex++;
    }
    
    params.push(couponId);
    
    const query = `
      UPDATE coupons 
      SET ${fields.join(', ')}
      WHERE id = $${paramIndex}
      RETURNING *
    `;
    
    const result = await db.query(query, params);
    return result.rows[0];
  }
  
  /**
   * åˆ é™¤ä¼˜æƒ åˆ¸
   */
  static async delete(couponId) {
    // æ£€æŸ¥æ˜¯å¦æœ‰ä½¿ç”¨è®°å½•
    const usageResult = await db.query(
      'SELECT COUNT(*) FROM user_coupons WHERE coupon_id = $1',
      [couponId]
    );
    
    const hasUsage = parseInt(usageResult.rows[0].count) > 0;
    
    if (hasUsage) {
      // æœ‰ä½¿ç”¨è®°å½•ï¼Œåªæ”¹çŠ¶æ€ä¸ºinactive
      await db.query(
        "UPDATE coupons SET status = 'inactive' WHERE id = $1",
        [couponId]
      );
      return { deleted: false, archived: true };
    } else {
      // æ— ä½¿ç”¨è®°å½•ï¼Œç‰©ç†åˆ é™¤
      await db.query('DELETE FROM coupons WHERE id = $1', [couponId]);
      return { deleted: true };
    }
  }
  
  /**
   * è·å–ç»Ÿè®¡ä¿¡æ¯
   */
  static async getStats(couponId) {
    const coupon = await this.findById(couponId);
    
    if (!coupon) {
      throw new Error('ä¼˜æƒ åˆ¸ä¸å­˜åœ¨');
    }
    
    // è·å–ä½¿ç”¨ç‡
    const usageRate = coupon.received_count > 0
      ? (coupon.used_count / coupon.received_count * 100).toFixed(2)
      : 0;
    
    // è·å–æ€»ä¼˜æƒ é‡‘é¢å’Œæ€»æ”¶å…¥
    const financialResult = await db.query(
      `SELECT 
        SUM(discount_amount) as total_discount,
        SUM(final_price) as total_revenue,
        AVG(discount_amount) as avg_discount
       FROM coupon_usages 
       WHERE coupon_id = $1`,
      [couponId]
    );
    
    const financial = financialResult.rows[0];
    
    // è·å–ä½¿ç”¨æœ€å¤šçš„ç”¨æˆ·
    const topUsersResult = await db.query(
      `SELECT 
        u.id as user_id,
        u.email,
        COUNT(*) as used_count,
        SUM(cu.discount_amount) as total_discount
       FROM coupon_usages cu
       JOIN users u ON cu.user_id = u.id
       WHERE cu.coupon_id = $1
       GROUP BY u.id, u.email
       ORDER BY used_count DESC
       LIMIT 10`,
      [couponId]
    );
    
    // è·å–æ¯æ—¥ç»Ÿè®¡
    const dailyStatsResult = await db.query(
      `SELECT 
        DATE(received_at) as date,
        COUNT(*) as received,
        SUM(CASE WHEN status = 'used' THEN 1 ELSE 0 END) as used
       FROM user_coupons
       WHERE coupon_id = $1
       GROUP BY DATE(received_at)
       ORDER BY date DESC
       LIMIT 30`,
      [couponId]
    );
    
    return {
      coupon_id: coupon.id,
      name: coupon.name,
      total_quantity: coupon.total_quantity,
      received_count: coupon.received_count,
      used_count: coupon.used_count,
      usage_rate: parseFloat(usageRate),
      total_discount: parseFloat(financial.total_discount || 0),
      total_revenue: parseFloat(financial.total_revenue || 0),
      avg_discount_per_order: parseFloat(financial.avg_discount || 0),
      top_users: topUsersResult.rows,
      daily_stats: dailyStatsResult.rows
    };
  }
}

module.exports = Coupon;
```

---

### 2. ç”¨æˆ·ä¼˜æƒ åˆ¸æ¨¡å‹ï¼ˆUserCoupon.jsï¼‰

```javascript
// src/models/UserCoupon.js

const db = require('../config/database');

class UserCoupon {
  /**
   * é¢†å–ä¼˜æƒ åˆ¸
   */
  static async receive(userId, couponId, expireAt = null) {
    const result = await db.query(
      `INSERT INTO user_coupons (user_id, coupon_id, expire_at)
       VALUES ($1, $2, $3)
       RETURNING *`,
      [userId, couponId, expireAt]
    );
    
    return result.rows[0];
  }
  
  /**
   * è·å–ç”¨æˆ·çš„ä¼˜æƒ åˆ¸åˆ—è¡¨
   */
  static async getUserCoupons(userId, status = null) {
    let query = `
      SELECT uc.*, c.*,
        uc.id as user_coupon_id,
        c.id as coupon_id
      FROM user_coupons uc
      JOIN coupons c ON uc.coupon_id = c.id
      WHERE uc.user_id = $1
    `;
    
    const params = [userId];
    
    if (status) {
      query += ' AND uc.status = $2';
      params.push(status);
    }
    
    query += ' ORDER BY uc.received_at DESC';
    
    const result = await db.query(query, params);
    return result.rows;
  }
  
  /**
   * è·å–ç”¨æˆ·å¯ç”¨çš„ä¼˜æƒ åˆ¸
   */
  static async getAvailable(userId) {
    const result = await db.query(
      `SELECT uc.*, c.*,
        uc.id as user_coupon_id,
        c.id as coupon_id
       FROM user_coupons uc
       JOIN coupons c ON uc.coupon_id = c.id
       WHERE uc.user_id = $1 
       AND uc.status = 'available'
       AND (uc.expire_at IS NULL OR uc.expire_at > NOW())
       AND c.end_time > NOW()
       ORDER BY uc.received_at DESC`,
      [userId]
    );
    
    return result.rows;
  }
  
  /**
   * ä½¿ç”¨ä¼˜æƒ åˆ¸
   */
  static async use(userCouponId, orderId) {
    const result = await db.query(
      `UPDATE user_coupons 
       SET status = 'used', used_at = NOW(), order_id = $2
       WHERE id = $1
       RETURNING *`,
      [userCouponId, orderId]
    );
    
    return result.rows[0];
  }
  
  /**
   * æ‰¹é‡å‘æ”¾ä¼˜æƒ åˆ¸
   */
  static async batchDistribute(userIds, couponId, expireAt) {
    const values = userIds.map((userId, index) => 
      `($${index * 3 + 1}, $${index * 3 + 2}, $${index * 3 + 3})`
    ).join(',');
    
    const params = [];
    userIds.forEach(userId => {
      params.push(userId, couponId, expireAt);
    });
    
    const query = `
      INSERT INTO user_coupons (user_id, coupon_id, expire_at)
      VALUES ${values}
      ON CONFLICT (user_id, coupon_id) DO NOTHING
      RETURNING *
    `;
    
    const result = await db.query(query, params);
    return result.rows;
  }
  
  /**
   * æ ‡è®°è¿‡æœŸçš„ä¼˜æƒ åˆ¸
   */
  static async markExpired() {
    const result = await db.query(
      `UPDATE user_coupons 
       SET status = 'expired'
       WHERE status = 'available' 
       AND (
         expire_at < NOW() 
         OR coupon_id IN (
           SELECT id FROM coupons WHERE end_time < NOW()
         )
       )
       RETURNING id`
    );
    
    return result.rows.length;
  }
}

module.exports = UserCoupon;
```

---

### 3. ä¼˜æƒ åˆ¸æœåŠ¡ï¼ˆCouponService.jsï¼‰

```javascript
// src/services/CouponService.js

const Coupon = require('../models/Coupon');
const UserCoupon = require('../models/UserCoupon');
const Plan = require('../models/Plan');
const { addDays } = require('../utils/dateHelper');

class CouponService {
  /**
   * è·å–å¯é¢†å–çš„ä¼˜æƒ åˆ¸åˆ—è¡¨
   */
  static async getAvailableCoupons(userId) {
    const coupons = await Coupon.getAvailable();
    
    const result = [];
    for (const coupon of coupons) {
      const hasReceived = await Coupon.hasUserReceived(userId, coupon.id);
      const receiveCount = await Coupon.getUserReceiveCount(userId, coupon.id);
      
      const canReceive = !hasReceived || receiveCount < coupon.per_user_limit;
      
      const remainingQuantity = coupon.total_quantity 
        ? coupon.total_quantity - coupon.received_count
        : null;
      
      result.push({
        ...this.formatCoupon(coupon),
        can_receive: canReceive && (remainingQuantity === null || remainingQuantity > 0),
        received: hasReceived,
        remaining_quantity: remainingQuantity
      });
    }
    
    return result;
  }
  
  /**
   * è·å–ç”¨æˆ·çš„ä¼˜æƒ åˆ¸
   */
  static async getMyCoupons(userId, status = null) {
    const userCoupons = await UserCoupon.getUserCoupons(userId, status);
    
    return userCoupons.map(uc => this.formatUserCoupon(uc));
  }
  
  /**
   * é¢†å–ä¼˜æƒ åˆ¸
   */
  static async receiveCoupon(userId, couponId) {
    const coupon = await Coupon.findById(couponId);
    
    if (!coupon) {
      throw new Error('ä¼˜æƒ åˆ¸ä¸å­˜åœ¨');
    }
    
    if (coupon.status !== 'active') {
      throw new Error('ä¼˜æƒ åˆ¸æœªæ¿€æ´»æˆ–å·²è¿‡æœŸ');
    }
    
    const now = new Date();
    if (now < new Date(coupon.start_time) || now > new Date(coupon.end_time)) {
      throw new Error('ä¼˜æƒ åˆ¸ä¸åœ¨æœ‰æ•ˆæœŸå†…');
    }
    
    if (coupon.distribution_type !== 'public') {
      throw new Error('è¯¥ä¼˜æƒ åˆ¸ä¸æ”¯æŒé¢†å–');
    }
    
    // æ£€æŸ¥é¢†å–æ¬¡æ•°
    const receiveCount = await Coupon.getUserReceiveCount(userId, couponId);
    if (receiveCount >= coupon.per_user_limit) {
      throw new Error('æ‚¨å·²è¾¾åˆ°è¯¥ä¼˜æƒ åˆ¸çš„é¢†å–ä¸Šé™');
    }
    
    // æ£€æŸ¥åº“å­˜
    if (coupon.total_quantity && coupon.received_count >= coupon.total_quantity) {
      throw new Error('ä¼˜æƒ åˆ¸å·²è¢«é¢†å®Œ');
    }
    
    // é¢†å–
    const userCoupon = await UserCoupon.receive(
      userId,
      couponId,
      coupon.end_time
    );
    
    // å¢åŠ é¢†å–è®¡æ•°
    await Coupon.incrementReceivedCount(couponId);
    
    return {
      user_coupon_id: userCoupon.id,
      coupon: this.formatCoupon(coupon),
      expire_at: userCoupon.expire_at
    };
  }
  
  /**
   * å…‘æ¢ä¼˜æƒ ç 
   */
  static async exchangeCode(userId, code) {
    const coupon = await Coupon.findByCode(code);
    
    if (!coupon) {
      throw new Error('æ— æ•ˆçš„ä¼˜æƒ ç ');
    }
    
    if (coupon.status !== 'active') {
      throw new Error('ä¼˜æƒ åˆ¸æœªæ¿€æ´»æˆ–å·²è¿‡æœŸ');
    }
    
    const now = new Date();
    if (now < new Date(coupon.start_time) || now > new Date(coupon.end_time)) {
      throw new Error('ä¼˜æƒ åˆ¸å·²è¿‡æœŸ');
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²å…‘æ¢
    const hasReceived = await Coupon.hasUserReceived(userId, coupon.id);
    if (hasReceived) {
      throw new Error('æ‚¨å·²å…‘æ¢è¿‡è¯¥ä¼˜æƒ ç ');
    }
    
    // å…‘æ¢
    const userCoupon = await UserCoupon.receive(
      userId,
      coupon.id,
      coupon.end_time
    );
    
    await Coupon.incrementReceivedCount(coupon.id);
    
    return {
      user_coupon_id: userCoupon.id,
      coupon: this.formatCoupon(coupon),
      expire_at: userCoupon.expire_at
    };
  }
  
  /**
   * éªŒè¯ä¼˜æƒ åˆ¸
   */
  static async validate(couponCode, userId, planId, amount) {
    // æŸ¥æ‰¾ä¼˜æƒ åˆ¸
    let coupon = await Coupon.findByCode(couponCode);
    if (!coupon) {
      coupon = await Coupon.findById(couponCode);
    }
    
    if (!coupon) {
      return {
        valid: false,
        reason: 'ä¼˜æƒ åˆ¸ä¸å­˜åœ¨'
      };
    }
    
    // æ£€æŸ¥çŠ¶æ€
    if (coupon.status !== 'active') {
      return {
        valid: false,
        reason: 'ä¼˜æƒ åˆ¸æœªæ¿€æ´»æˆ–å·²å¤±æ•ˆ'
      };
    }
    
    // æ£€æŸ¥æ—¶é—´
    const now = new Date();
    if (now < new Date(coupon.start_time) || now > new Date(coupon.end_time)) {
      return {
        valid: false,
        reason: 'ä¼˜æƒ åˆ¸ä¸åœ¨æœ‰æ•ˆæœŸå†…'
      };
    }
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰è¯¥ä¼˜æƒ åˆ¸
    const userCoupons = await UserCoupon.getAvailable(userId);
    const hasUserCoupon = userCoupons.some(uc => 
      uc.coupon_id === coupon.id && uc.status === 'available'
    );
    
    if (!hasUserCoupon && coupon.distribution_type !== 'code') {
      return {
        valid: false,
        reason: 'æ‚¨æ²¡æœ‰è¯¥ä¼˜æƒ åˆ¸'
      };
    }
    
    // æ£€æŸ¥æœ€ä½æ¶ˆè´¹
    if (coupon.min_purchase_amount && amount < coupon.min_purchase_amount) {
      return {
        valid: false,
        reason: 'æœªè¾¾åˆ°æœ€ä½æ¶ˆè´¹é‡‘é¢',
        min_purchase_amount: parseFloat(coupon.min_purchase_amount)
      };
    }
    
    // æ£€æŸ¥é€‚ç”¨å¥—é¤
    if (coupon.applicable_plans) {
      const applicablePlans = JSON.parse(coupon.applicable_plans);
      if (!applicablePlans.includes(planId)) {
        return {
          valid: false,
          reason: 'è¯¥ä¼˜æƒ åˆ¸ä¸é€‚ç”¨äºæ‰€é€‰å¥—é¤'
        };
      }
    }
    
    // æ£€æŸ¥æ’é™¤å¥—é¤
    if (coupon.exclude_plans) {
      const excludePlans = JSON.parse(coupon.exclude_plans);
      if (excludePlans.includes(planId)) {
        return {
          valid: false,
          reason: 'è¯¥ä¼˜æƒ åˆ¸ä¸é€‚ç”¨äºæ‰€é€‰å¥—é¤'
        };
      }
    }
    
    // è®¡ç®—ä¼˜æƒ é‡‘é¢
    const discountAmount = this.calculateDiscount(coupon, amount);
    
    return {
      valid: true,
      coupon: this.formatCoupon(coupon),
      discount_amount: discountAmount,
      final_amount: amount - discountAmount
    };
  }
  
  /**
   * è®¡ç®—ä¼˜æƒ é‡‘é¢
   */
  static calculateDiscount(coupon, amount) {
    let discount = 0;
    
    switch (coupon.type) {
      case 'fixed_amount':
        // å›ºå®šé‡‘é¢
        discount = Math.min(parseFloat(coupon.value), amount);
        break;
        
      case 'percentage':
        // ç™¾åˆ†æ¯”æŠ˜æ‰£
        discount = amount * (parseFloat(coupon.value) / 100);
        if (coupon.max_discount_amount) {
          discount = Math.min(discount, parseFloat(coupon.max_discount_amount));
        }
        break;
        
      case 'full_reduction':
        // æ»¡å‡
        if (amount >= parseFloat(coupon.min_purchase_amount)) {
          discount = parseFloat(coupon.value);
        }
        break;
    }
    
    return parseFloat(discount.toFixed(2));
  }
  
  /**
   * åˆ›å»ºä¼˜æƒ åˆ¸
   */
  static async createCoupon(couponData, adminId) {
    // éªŒè¯æ•°æ®
    if (!couponData.id || !couponData.name || !couponData.type || !couponData.value) {
      throw new Error('ç¼ºå°‘å¿…å¡«å­—æ®µ');
    }
    
    // æ£€æŸ¥IDæ˜¯å¦å·²å­˜åœ¨
    const existing = await Coupon.findById(couponData.id);
    if (existing) {
      throw new Error('ä¼˜æƒ åˆ¸IDå·²å­˜åœ¨');
    }
    
    const coupon = await Coupon.create({
      ...couponData,
      createdBy: adminId
    });
    
    return this.formatCoupon(coupon);
  }
  
  /**
   * æ‰¹é‡å‘æ”¾ä¼˜æƒ åˆ¸
   */
  static async distributeCoupons(couponId, targetType, targets, expireDays) {
    const coupon = await Coupon.findById(couponId);
    
    if (!coupon) {
      throw new Error('ä¼˜æƒ åˆ¸ä¸å­˜åœ¨');
    }
    
    let userIds = [];
    
    if (targetType === 'user_ids') {
      userIds = targets;
    } else if (targetType === 'user_filter') {
      // æ ¹æ®è¿‡æ»¤æ¡ä»¶æŸ¥è¯¢ç”¨æˆ·
      userIds = await this.getUsersByFilter(targets);
    }
    
    if (userIds.length === 0) {
      throw new Error('æ²¡æœ‰æ‰¾åˆ°ç›®æ ‡ç”¨æˆ·');
    }
    
    const expireAt = expireDays 
      ? addDays(new Date(), expireDays)
      : coupon.end_time;
    
    const distributed = await UserCoupon.batchDistribute(userIds, couponId, expireAt);
    
    return {
      distributed_count: distributed.length,
      target_users: userIds.length
    };
  }
  
  /**
   * æ ¹æ®è¿‡æ»¤æ¡ä»¶è·å–ç”¨æˆ·IDåˆ—è¡¨
   */
  static async getUsersByFilter(filter) {
    let query = 'SELECT id FROM users WHERE 1=1';
    const params = [];
    let paramIndex = 1;
    
    if (filter.registered_after) {
      query += ` AND created_at >= $${paramIndex}`;
      params.push(filter.registered_after);
      paramIndex++;
    }
    
    if (filter.no_subscription) {
      query += ` AND id NOT IN (
        SELECT user_id FROM subscriptions WHERE status = 'active'
      )`;
    }
    
    const result = await db.query(query, params);
    return result.rows.map(row => row.id);
  }
  
  /**
   * æ ¼å¼åŒ–ä¼˜æƒ åˆ¸
   */
  static formatCoupon(coupon) {
    return {
      id: coupon.id,
      name: coupon.name,
      description: coupon.description,
      code: coupon.code,
      type: coupon.type,
      value: parseFloat(coupon.value),
      min_purchase_amount: coupon.min_purchase_amount 
        ? parseFloat(coupon.min_purchase_amount) 
        : null,
      max_discount_amount: coupon.max_discount_amount
        ? parseFloat(coupon.max_discount_amount)
        : null,
      applicable_plans: coupon.applicable_plans 
        ? JSON.parse(coupon.applicable_plans)
        : null,
      start_time: coupon.start_time,
      end_time: coupon.end_time,
      per_user_limit: coupon.per_user_limit,
      stackable: coupon.stackable,
      status: coupon.status
    };
  }
  
  /**
   * æ ¼å¼åŒ–ç”¨æˆ·ä¼˜æƒ åˆ¸
   */
  static formatUserCoupon(userCoupon) {
    const daysRemaining = userCoupon.expire_at
      ? Math.ceil((new Date(userCoupon.expire_at) - new Date()) / (1000 * 60 * 60 * 24))
      : null;
    
    return {
      user_coupon_id: userCoupon.user_coupon_id,
      coupon: {
        id: userCoupon.coupon_id,
        name: userCoupon.name,
        description: userCoupon.description,
        type: userCoupon.type,
        value: parseFloat(userCoupon.value),
        min_purchase_amount: userCoupon.min_purchase_amount
          ? parseFloat(userCoupon.min_purchase_amount)
          : null
      },
      status: userCoupon.status,
      received_at: userCoupon.received_at,
      used_at: userCoupon.used_at,
      expire_at: userCoupon.expire_at,
      days_remaining: daysRemaining,
      order_id: userCoupon.order_id
    };
  }
}

module.exports = CouponService;
```

---

### 4. ä¼˜æƒ åˆ¸è¿‡æœŸä»»åŠ¡ï¼ˆcouponExpiration.jsï¼‰

```javascript
// src/jobs/couponExpiration.js

const cron = require('node-cron');
const UserCoupon = require('../models/UserCoupon');

/**
 * ä¼˜æƒ åˆ¸è¿‡æœŸä»»åŠ¡
 * æ¯å¤©å‡Œæ™¨1ç‚¹æ‰§è¡Œ
 */
function startCouponExpirationJob() {
  cron.schedule('0 1 * * *', async () => {
    try {
      console.log('[ä¼˜æƒ åˆ¸è¿‡æœŸä»»åŠ¡] å¼€å§‹æ‰§è¡Œ...');
      
      const expiredCount = await UserCoupon.markExpired();
      
      console.log(`[ä¼˜æƒ åˆ¸è¿‡æœŸä»»åŠ¡] å·²æ ‡è®° ${expiredCount} å¼ ä¼˜æƒ åˆ¸ä¸ºè¿‡æœŸ`);
      
    } catch (error) {
      console.error('[ä¼˜æƒ åˆ¸è¿‡æœŸä»»åŠ¡] æ‰§è¡Œå¤±è´¥:', error);
    }
  });
  
  console.log('ä¼˜æƒ åˆ¸è¿‡æœŸä»»åŠ¡å·²å¯åŠ¨ï¼ˆæ¯å¤©å‡Œæ™¨1ç‚¹æ‰§è¡Œï¼‰');
}

module.exports = {
  startCouponExpirationJob
};
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

```javascript
// tests/unit/CouponService.test.js

const CouponService = require('../../src/services/CouponService');
const Coupon = require('../../src/models/Coupon');

jest.mock('../../src/models/Coupon');

describe('CouponService', () => {
  describe('calculateDiscount', () => {
    it('å›ºå®šé‡‘é¢ä¼˜æƒ åˆ¸åº”è¯¥è¿”å›æ­£ç¡®çš„ä¼˜æƒ ', () => {
      const coupon = {
        type: 'fixed_amount',
        value: '20.00'
      };
      
      const discount = CouponService.calculateDiscount(coupon, 100);
      expect(discount).toBe(20.00);
    });
    
    it('ç™¾åˆ†æ¯”ä¼˜æƒ åˆ¸åº”è¯¥è®¡ç®—æ­£ç¡®', () => {
      const coupon = {
        type: 'percentage',
        value: '20',
        max_discount_amount: null
      };
      
      const discount = CouponService.calculateDiscount(coupon, 100);
      expect(discount).toBe(20.00);
    });
    
    it('ç™¾åˆ†æ¯”ä¼˜æƒ åˆ¸åº”è¯¥ä¸è¶…è¿‡æœ€å¤§ä¼˜æƒ é‡‘é¢', () => {
      const coupon = {
        type: 'percentage',
        value: '20',
        max_discount_amount: '15.00'
      };
      
      const discount = CouponService.calculateDiscount(coupon, 100);
      expect(discount).toBe(15.00);
    });
  });
});
```

---

## ğŸ“ æ€»ç»“

ä¼˜æƒ åˆ¸ç³»ç»Ÿå®Œæˆï¼ŒåŒ…å«ï¼š

âœ… å®Œæ•´çš„ä¼˜æƒ åˆ¸åˆ›å»ºå’Œç®¡ç†
âœ… ä¸‰ç§ä¼˜æƒ ç±»å‹ï¼ˆå›ºå®šé‡‘é¢ã€ç™¾åˆ†æ¯”ã€æ»¡å‡ï¼‰
âœ… å¤šç»´åº¦ä½¿ç”¨é™åˆ¶
âœ… æ‰¹é‡å‘æ”¾åŠŸèƒ½
âœ… ä½¿ç”¨éªŒè¯å’Œç»Ÿè®¡
âœ… 10ä¸ªAPIæ¥å£

**ä¸‹ä¸€ä¸ªåŠŸèƒ½ï¼š** é‚€è¯·è¿”åˆ©ç³»ç»Ÿ

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**æœ€åæ›´æ–°ï¼š** 2024-12-26  
**ä½œè€…ï¼š** Claude
